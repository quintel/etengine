class UpdateConverterLayoutKeys < ActiveRecord::Migration
  def up
    say_with_time 'Updating ConverterPosition keys' do
      # DATA.read isn't working?
      keys = YAML.load(Pathname.new(__FILE__).read.split(/^__END__$/, 2).last)

      ConverterPosition.all.select(&:converter_id).each do |pos|
        pos.update_attributes!(converter_key: keys[pos.converter_id])
      end
    end

    say_with_time 'Cleaning up old ConverterPosition records' do
      # Remove any which were accidentally added by visiting the layout.
      ConverterPosition.where(
        'created_at >= ? AND converter_id IS NULL', 5.days.ago
      ).destroy_all

      ConverterPosition.where('converter_key IS NULL').destroy_all

      # Remove duplicates before adding the unique index.
      ConverterPosition.group(:converter_key)
        .having('count(*) > 1').destroy_all
    end

    change_column :converter_positions, :converter_key, :string, null: false
    remove_column :converter_positions, :converter_id

    add_index :converter_positions, :converter_key, unique: true
  end

  def down
    fail ActiveRecord::IrreversibleMigration
  end
end

__END__
---
1: :households_useful_demand_hot_water
2: :households_useful_demand_for_cooling_after_insulation
4: :households_useful_demand_for_space_heating_after_insulation
6: :households_lighting_led_electricity
7: :households_lighting_efficient_fluorescent_electricity
8: :households_lighting_incandescent_electricity
10: :households_appliances_other_electricity
11: :households_water_heater_solar_thermal
12: :households_water_heater_heatpump_ground_water_electricity
13: :households_water_heater_resistive_electricity
14: :households_space_heater_heatpump_air_water_electricity
15: :households_cooling_airconditioning_electricity
16: :households_space_heater_electricity
19: :households_space_heater_combined_network_gas
20: :energy_power_solar_pv_solar_radiation
21: :energy_power_lv_network_electricity
22: :households_heat_network_connection_steam_hot_water
23: :energy_power_ultra_supercritical_network_gas
24: :industry_useful_demand_electricity
25: :industry_useful_demand_useable_heat
26: :energy_power_mv_distribution_network_electricity
27: :industry_chp_combined_cycle_gas_power_fuelmix
28: :energy_chp_combined_cycle_network_gas
32: :transport_useful_demand_truck_kms
33: :transport_useful_demand_car_kms
34: :transport_truck_using_electricity
35: :transport_truck_using_diesel_mix
36: :transport_truck_using_gasoline_mix
37: :transport_car_using_electricity
38: :transport_car_using_diesel_mix
39: :transport_car_using_gasoline_mix
40: :transport_car_using_lpg
41: :transport_truck_using_compressed_natural_gas
42: :transport_car_using_compressed_natural_gas
44: :transport_useful_demand_crude_oil_non_energetic
46: :transport_ship_using_diesel
47: :transport_ship_using_biodiesel
48: :transport_train_using_electricity
49: :buildings_useful_demand_cooling
52: :households_space_heater_heatpump_ground_water_electricity
55: :buildings_cooling_collective_cooling_network_electricity
56: :agriculture_useful_demand_useable_heat
57: :agriculture_final_demand_for_heat_network_gas
58: :agriculture_useful_demand_electricity
61: :transport_train_using_coal
62: :other_useful_demand_electricity
63: :energy_heat_network_steam_hot_water
64: :energy_power_supercritical_waste_mix
65: :energy_power_hv_network_electricity
66: :energy_power_ultra_supercritical_coal
67: :energy_power_ultra_supercritical_ccs_coal
68: :energy_power_supercritical_coal
69: :energy_power_ultra_supercritical_lignite
70: :energy_power_ultra_supercritical_oxyfuel_ccs_lignite
71: :energy_power_combined_cycle_coal
72: :energy_power_combined_cycle_ccs_coal
73: :energy_power_ultra_supercritical_crude_oil
74: :energy_power_combined_cycle_network_gas
75: :energy_chp_ultra_supercritical_coal
76: :households_water_heater_district_heating_steam_hot_water
78: :energy_interconnector_imported_electricity
79: :energy_power_nuclear_gen3_uranium_oxide
80: :energy_power_wind_turbine_inland
81: :energy_power_wind_turbine_coastal
82: :energy_power_wind_turbine_offshore
85: :energy_power_solar_csp_solar_radiation
86: :energy_heater_for_heat_network_geothermal
87: :energy_power_hydro_river
88: :energy_power_hydro_mountain
90: :energy_power_geothermal
91: :energy_national_gas_network_natural_gas
92: :energy_treatment_natural_gas
93: :energy_distribution_diesel
94: :energy_distribution_gasoline
95: :energy_distribution_kerosene
96: :energy_distribution_biodiesel
97: :energy_distribution_bio_ethanol
99: :energy_distribution_lpg
100: :energy_production_bio_oil
101: :energy_production_bio_residues_for_firing
102: :energy_extraction_natural_gas
103: :energy_distribution_bio_oil
104: :energy_extraction_crude_oil
105: :energy_import_lng
106: :energy_extraction_coal
107: :energy_import_uranium_oxide
109: :energy_distribution_crude_oil
111: :energy_distribution_bio_residues_for_firing
112: :energy_distribution_greengas
113: :energy_distribution_coal
114: :other_final_demand_for_heat_coal
115: :other_final_demand_for_heat_crude_oil
116: :industry_final_demand_for_heat_crude_oil
117: :industry_final_demand_for_heat_network_gas
119: :industry_useful_demand_coal_non_energetic
120: :industry_final_demand_for_heat_wood_pellets
123: :other_final_demand_for_heat_gas
125: :transport_train_using_diesel
126: :energy_production_lpg
127: :energy_production_diesel
128: :energy_production_gasoline
129: :energy_production_kerosene
130: :energy_production_biodiesel
131: :energy_production_bio_ethanol
136: :energy_treatment_uranium_oxide
137: :energy_distribution_uranium_oxide
138: :energy_import_crude_oil
139: :energy_import_natural_gas
142: :energy_import_diesel
143: :energy_import_gasoline
144: :energy_import_kerosene
145: :energy_import_biodiesel
146: :energy_import_bio_ethanol
148: :energy_import_lpg
149: :transport_plane_using_gasoline
151: :other_useful_demand_crude_oil_non_energetic
152: :industry_useful_demand_crude_oil_non_energetic
153: :industry_useful_demand_network_gas_non_energetic
156: :industry_useful_demand_wood_pellets_non_energetic
157: :households_water_heater_combined_network_gas
160: :industry_final_demand_for_heat_coal
161: :industry_useful_demand_electricity_non_energetic
162: :agriculture_final_demand_electricity
163: :agriculture_final_demand_network_gas
164: :agriculture_final_demand_crude_oil
165: :agriculture_final_demand_steam_hot_water
167: :households_final_demand_wood_pellets
168: :households_final_demand_coal
169: :households_final_demand_electricity
170: :households_final_demand_network_gas
172: :households_final_demand_crude_oil
173: :households_final_demand_steam_hot_water
175: :industry_final_demand_wood_pellets
176: :industry_final_demand_coal
177: :industry_final_demand_electricity
178: :industry_final_demand_network_gas
180: :industry_final_demand_crude_oil
181: :industry_final_demand_steam_hot_water
184: :other_final_demand_wood_pellets
185: :other_final_demand_coal
186: :other_final_demand_electricity
187: :other_final_demand_network_gas
188: :other_final_demand_crude_oil
189: :other_final_demand_steam_hot_water
190: :buildings_final_demand_network_gas
200: :industry_final_demand_wood_pellets_non_energetic
201: :industry_final_demand_coal_non_energetic
202: :industry_final_demand_electricity_non_energetic
203: :industry_final_demand_network_gas_non_energetic
205: :industry_final_demand_crude_oil_non_energetic
206: :buildings_final_demand_electricity
210: :other_final_demand_crude_oil_non_energetic
211: :transport_final_demand_crude_oil_non_energetic
212: :households_space_heater_wood_pellets
213: :households_space_heater_coal
215: :households_space_heater_crude_oil
217: :households_useful_demand_light
218: :agriculture_final_demand_for_heat_crude_oil
220: :other_final_demand_for_heat_wood_pellets
223: :energy_power_hv_network_loss
224: :energy_distribution_crude_oil_loss
225: :energy_distribution_network_gas_loss
226: :energy_heat_network_loss
227: :energy_final_demand_electricity
228: :energy_final_demand_crude_oil
229: :energy_final_demand_network_gas
230: :energy_final_demand_steam_hot_water
231: :households_solar_pv_solar_radiation
240: :energy_extraction_uranium_oxide
242: :energy_import_greengas
243: :energy_import_coal
245: :energy_heat_network_unused_steam_hot_water
246: :energy_import_bio_oil
249: :energy_import_electricity
250: :environment_earth
251: :environment_water
256: :energy_production_algae_diesel
257: :environment_sun
258: :environment_air
261: :other_chp_engine_network_gas
262: :agriculture_burner_wood_pellets
263: :agriculture_burner_crude_oil
264: :agriculture_burner_network_gas
265: :agriculture_chp_engine_network_gas
266: :other_useful_demand_useable_heat
267: :other_burner_coal
268: :other_burner_crude_oil
269: :other_burner_wood_pellets
270: :other_burner_network_gas
271: :households_water_heater_wood_pellets
272: :energy_extraction_lignite
273: :industry_burner_coal
274: :industry_burner_crude_oil
275: :industry_burner_wood_pellets
276: :industry_burner_network_gas
279: :agriculture_heatpump_water_water_ts_electricity
280: :agriculture_geothermal
281: :agriculture_final_demand_for_heat_wood_pellets
283: :energy_distribution_lignite
284: :energy_distribution_waste_mix
285: :households_old_houses_useful_demand_for_heating
286: :households_old_houses_heating_savings_from_insulation
287: :energy_mixer_for_gas_power_fuel
289: :energy_distribution_algae_diesel
290: :energy_import_algae_diesel
293: :households_water_heater_coal
294: :households_water_heater_crude_oil
298: :industry_unused_local_production_steam_hot_water
299: :other_unused_local_production_steam_hot_water
300: :agriculture_unused_local_production_steam_hot_water
301: :energy_power_transformer_lv_mv_electricity
302: :energy_power_mv_transport_network_electricity
303: :energy_power_transformer_mv_hv_electricity
308: :energy_heat_network_backup_heater_network_gas
312: :energy_export_electricity
313: :buildings_useful_demand_for_space_heating
314: :households_new_houses_useful_demand_for_heating
316: :households_space_heater_heatpump_add_on_electricity
318: :households_collective_chp_network_gas
319: :households_collective_chp_wood_pellets
320: :households_collective_geothermal
321: :households_cooling_heatpump_ground_water_electricity
323: :households_cooling_heatpump_air_water_electricity
324: :households_useful_demand_cooking_useable_heat
325: :households_cooker_network_gas
326: :households_cooker_resistive_electricity
327: :households_cooker_halogen_electricity
328: :households_cooker_induction_electricity
329: :households_appliances_dishwasher_electricity
330: :households_appliances_fridge_freezer_electricity
332: :households_appliances_vacuum_cleaner_electricity
333: :households_appliances_washing_machine_electricity
334: :households_appliances_clothes_dryer_electricity
335: :households_appliances_television_electricity
337: :households_appliances_computer_media_electricity
338: :buildings_heating_savings_from_insulation_useable_heat
342: :buildings_useful_demand_after_motion_detection_daylight_control_light
343: :buildings_lighting_standard_fluorescent_electricity
344: :buildings_lighting_efficient_fluorescent_electricity
345: :buildings_lighting_led_electricity
346: :buildings_solar_pv_solar_radiation
347: :buildings_heat_network_connection_steam_hot_water
348: :buildings_space_heater_network_gas
349: :buildings_space_heater_electricity
350: :buildings_collective_chp_network_gas
352: :buildings_collective_chp_wood_pellets
353: :buildings_space_heater_solar_thermal
354: :buildings_space_heater_heatpump_air_water_network_gas
355: :buildings_space_heater_wood_pellets
356: :buildings_space_heater_collective_heatpump_water_water_ts_electricity
357: :buildings_cooling_heatpump_air_water_network_gas
358: :buildings_cooling_collective_heatpump_water_water_ts_electricity
360: :buildings_cooling_airconditioning_electricity
361: :buildings_useful_demand_for_appliances
362: :buildings_final_demand_wood_pellets
363: :buildings_final_demand_coal
364: :buildings_final_demand_crude_oil
366: :buildings_final_demand_steam_hot_water
367: :households_old_houses_useful_demand_for_cooling
368: :households_new_houses_useful_demand_for_cooling
369: :households_old_houses_cooling_savings_from_insulation
370: :households_new_houses_cooling_savings_from_insulation
371: :households_new_houses_heating_savings_from_insulation
374: :buildings_cooling_savings_insulation_cooling
375: :households_water_heater_network_gas
376: :households_water_heater_micro_chp_network_gas
377: :buildings_space_heater_crude_oil
378: :buildings_space_heater_coal
379: :buildings_useful_demand_for_space_heating_after_insulation
381: :buildings_useful_demand_after_insulation_cooling
387: :buildings_useful_demand_after_motion_detection_light
388: :buildings_useful_demand_light
389: :buildings_lighting_savings_from_daylight_control_light
390: :buildings_lighting_savings_from_motion_detection_light
391: :households_space_heater_district_heating_steam_hot_water
392: :energy_power_nuclear_gen2_uranium_oxide
394: :households_locally_available_electricity
399: :buildings_appliances_crude_oil
400: :buildings_appliances_network_gas
401: :buildings_appliances_wood_pellets
402: :buildings_appliances_electricity
409: :energy_power_combined_cycle_ccs_network_gas
410: :agriculture_locally_available_electricity
411: :agriculture_locally_available_steam_hot_water
412: :industry_locally_available_electricity
413: :industry_locally_available_steam_hot_water
414: :energy_heat_remainder_from_heat_network_used_steam_hot_water
415: :energy_heat_remainder_from_heat_network_unused_steam_hot_water
416: :energy_heat_remainder_from_heat_network_steam_hot_water
417: :households_space_heater_micro_chp_network_gas
419: :other_local_production_steam_hot_water
420: :other_local_production_electricity
421: :buildings_local_production_electricity
423: :energy_chp_ultra_supercritical_lignite
425: :energy_power_hydro_mountain_pumped
426: :transport_useful_demand_planes
427: :transport_plane_using_bio_ethanol
428: :transport_useful_demand_trains
429: :transport_useful_demand_ships
430: :energy_heater_for_heat_network_coal
431: :energy_heater_for_heat_network_lignite
432: :energy_heater_for_heat_network_crude_oil
433: :energy_heater_for_heat_network_network_gas
434: :energy_heater_for_heat_network_waste_mix
435: :energy_heater_for_heat_network_wood_pellets
438: :industry_chp_ultra_supercritical_coal
439: :households_cooker_wood_pellets
440: :households_space_heater_network_gas
441: :households_water_heater_fuel_cell_chp_network_gas
442: :households_useful_demand_for_hot_water_after_solar_heater_and_add_on
477: :energy_production_biogas
478: :energy_distribution_biogas
486: :energy_distribution_torrified_biomass_pellets
487: :energy_torrefaction_wood
489: :energy_import_steam_hot_water
491: :energy_import_torrified_biomass_pellets
492: :energy_distribution_wood_pellets
493: :energy_production_wood_pellets
494: :energy_import_wood_pellets
495: :energy_distribution_wood
496: :energy_production_wood
497: :energy_upgrade_biogas
498: :energy_distribution_manure
499: :energy_production_manure
500: :energy_distribution_corn
501: :energy_production_corn
503: :energy_export_uranium_oxide
504: :energy_export_crude_oil
505: :energy_export_network_gas
507: :energy_export_diesel
508: :energy_export_gasoline
509: :energy_export_kerosene
511: :energy_export_lpg
512: :energy_export_greengas
513: :energy_export_coal
514: :energy_export_bio_oil
515: :energy_export_waste_mix
516: :energy_export_biodiesel
517: :energy_export_bio_ethanol
518: :energy_export_algae_diesel
519: :energy_distribution_biogenic_waste
520: :energy_distribution_non_biogenic_waste
521: :energy_import_biogenic_waste
522: :energy_import_non_biogenic_waste
523: :energy_production_biogenic_waste
524: :energy_production_non_biogenic_waste
534: :households_final_demand_for_hot_water_solar_thermal
535: :households_final_demand_solar_thermal
536: :energy_production_solar_thermal
537: :households_final_demand_for_space_heating_coal
538: :households_final_demand_for_hot_water_coal
539: :households_final_demand_for_space_heating_crude_oil
540: :households_final_demand_for_hot_water_crude_oil
541: :households_final_demand_for_space_heating_network_gas
542: :households_final_demand_for_cooling_network_gas
543: :households_final_demand_for_hot_water_network_gas
544: :households_final_demand_for_cooking_network_gas
545: :households_final_demand_for_space_heating_wood_pellets
546: :households_final_demand_for_hot_water_wood_pellets
547: :households_final_demand_for_cooking_wood_pellets
548: :households_final_demand_for_space_heating_electricity
549: :households_final_demand_for_cooling_electricity
550: :households_final_demand_for_hot_water_electricity
551: :households_final_demand_for_cooking_electricity
552: :households_final_demand_for_lighting_electricity
553: :households_final_demand_for_appliances_electricity
554: :households_final_demand_for_space_heating_steam_hot_water
555: :households_final_demand_for_hot_water_steam_hot_water
556: :energy_power_engine_diesel
557: :energy_power_turbine_network_gas
558: :transport_final_demand_coal
559: :transport_final_demand_lpg
560: :transport_final_demand_gasoline
561: :transport_final_demand_kerosene
562: :transport_final_demand_diesel
563: :transport_final_demand_heavy_fuel_oil
564: :transport_final_demand_network_gas
565: :transport_final_demand_bio_ethanol
566: :transport_final_demand_biodiesel
567: :transport_final_demand_electricity
568: :energy_distribution_heavy_fuel_oil
569: :energy_production_heavy_fuel_oil
570: :transport_final_demand_for_road_lpg
571: :transport_final_demand_for_road_gasoline
572: :transport_final_demand_for_road_diesel
573: :transport_final_demand_for_road_network_gas
574: :transport_final_demand_for_road_bio_ethanol
575: :transport_final_demand_for_road_biodiesel
576: :transport_final_demand_for_road_electricity
577: :transport_final_demand_for_rail_coal
578: :transport_final_demand_for_rail_diesel
579: :transport_final_demand_for_rail_biodiesel
580: :transport_final_demand_for_rail_electricity
581: :transport_final_demand_for_shipping_diesel
582: :transport_final_demand_for_shipping_heavy_fuel_oil
583: :transport_final_demand_for_aviation_gasoline
584: :transport_final_demand_for_aviation_kerosene
585: :transport_road_mixer_gasoline
586: :transport_road_mixer_diesel
587: :transport_road_compressor_network_gas
588: :transport_rail_mixer_diesel
589: :transport_final_demand_for_shipping_biodiesel
590: :transport_final_demand_for_aviation_biodiesel
591: :transport_plane_using_kerosene
592: :transport_ship_using_heavy_fuel_oil
593: :other_heater_district_heating_steam_hot_water
594: :other_final_demand_for_heat_steam_hot_water
595: :other_electricity_for_electricity
596: :buildings_space_heater_district_heating_steam_hot_water
597: :buildings_appliances_coal
598: :buildings_collective_geothermal
599: :buildings_final_demand_for_space_heating_coal
600: :buildings_final_demand_for_space_heating_crude_oil
601: :buildings_final_demand_for_space_heating_gas
602: :buildings_final_demand_for_space_heating_wood_pellets
603: :buildings_final_demand_for_space_heating_solar
604: :buildings_final_demand_for_space_heating_electricity
605: :buildings_final_demand_for_space_heating_heat
606: :buildings_final_demand_for_cooling_gas
607: :buildings_final_demand_for_cooling_electricity
608: :buildings_final_demand_for_lighting_electricity
609: :buildings_final_demand_for_appliances_coal
610: :buildings_final_demand_for_appliances_crude_oil
611: :buildings_final_demand_for_appliances_gas
612: :buildings_final_demand_for_appliances_wood_pellets
613: :buildings_final_demand_for_appliances_electricity
614: :buildings_final_demand_solar_thermal
615: :households_useful_demand_for_space_heating_after_insulation_and_solar_heater
616: :households_useful_demand_for_space_heating_after_insulation_and_solar_heater_and_add_on
617: :households_useful_demand_for_hot_water_after_solar_heater
618: :households_useful_demand_for_space_heating_after_insulation_for_houses_with_solar_heater
619: :households_useful_demand_for_hot_water_for_houses_with_solar_heater
620: :households_useful_demand_for_space_heating_after_insulation_for_houses_with_add_on
621: :households_useful_demand_for_hot_water_for_houses_with_add_on
622: :households_water_heater_heatpump_air_water_electricity
623: :industry_aluminium_production
624: :industry_aluminium_electrolysis_current_electricity
625: :industry_aluminium_electrolysis_bat_electricity
626: :industry_aluminium_smeltoven_electricity
627: :industry_aluminium_carbothermalreduction_electricity
628: :industry_aluminium_burner_network_gas
629: :industry_other_metals_production
630: :industry_other_metals_process_electricity
631: :industry_other_metals_process_heat_useable_heat
632: :industry_other_metals_burner_network_gas
633: :industry_steel_production
634: :industry_steel_blastfurnace_current_consumption_useable_heat
635: :industry_steel_blastfurnace_bat_consumption_useable_heat
636: :industry_steel_hisarna_consumption_useable_heat
637: :industry_steel_electricfurnace_electricity
638: :industry_steel_blastfurnace_burner_coal_gas
639: :industry_steel_electricfurnace_burner_network_gas
640: :industry_final_demand_coal_gas
641: :energy_distribution_coal_gas
642: :energy_steel_blastfurnace_current_transformation_cokes
643: :energy_steel_blastfurnace_bat_transformation_cokes
644: :energy_steel_hisarna_transformation_coal
645: :energy_distribution_cokes
646: :energy_import_coal_gas
647: :energy_export_coal_gas
648: :energy_cokesoven_consumption_coal_gas
649: :energy_cokesoven_transformation_coal
650: :energy_import_cokes
651: :energy_export_cokes
652: :industry_transformation_generic_coal
653: :industry_own_use_coal
654: :agriculture_chp_engine_biogas
655: :industry_chp_turbine_gas_power_fuelmix
656: :industry_chp_engine_gas_power_fuelmix
657: :agriculture_chp_supercritical_wood_pellets
658: :households_collective_chp_biogas
659: :energy_chp_supercritical_waste_mix
660: :other_chp_engine_biogas
661: :agriculture_chp_engine_biogas_dumped_heat
662: :households_collective_chp_biogas_dumped_heat
663: :other_chp_engine_biogas_dumped_heat
664: :energy_power_sector_own_use_electricity
665: :energy_power_ultra_supercritical_coal_rdr
666: :energy_power_ultra_supercritical_cofiring_coal_rdr
667: :energy_chp_ultra_supercritical_coal_rdr
668: :energy_chp_ultra_supercritical_cofiring_coal_rdr
669: :buildings_chp_engine_biogas
670: :buildings_chp_engine_biogas_dumped_heat
671: :industry_final_demand_for_metal_electricity
672: :industry_final_demand_for_other_electricity
673: :industry_final_demand_for_metal_coal
674: :industry_final_demand_for_other_coal
675: :industry_final_demand_for_metal_coal_gas
676: :industry_final_demand_for_other_coal_gas
677: :industry_final_demand_for_metal_network_gas
678: :industry_final_demand_for_other_network_gas
679: :industry_final_demand_for_metal_wood_pellets
680: :industry_final_demand_for_other_wood_pellets
681: :industry_final_demand_for_metal_crude_oil
682: :industry_final_demand_for_other_crude_oil
683: :industry_final_demand_for_metal_steam_hot_water
684: :industry_final_demand_for_other_steam_hot_water
685: :industry_final_demand_for_heat_steam_hot_water
686: :energy_import_lignite
687: :energy_export_lignite
688: :energy_export_wood_pellets
689: :energy_export_torrified_biomass_pellets
