- content_for(:title, 'Scenarios')

= render "inspect/shared/inspect_subnav"

%section#search_box
  = form_tag inspect_scenarios_path, method: :get do
    = search_field_tag :q, params[:q], placeholder: 'Scenario ID'
    = submit_tag 'Search', class: 'btn'

%p
  = link_to "Create a new scenario", new_inspect_scenario_path, class: 'btn btn-primary'
  - if params[:api_scenario_id]
    = link_to 'View current scenario', inspect_scenario_path(id: params[:api_scenario_id]), class: 'btn'

.row
  .span12
    %h3 Download scenarios by ID
    = text_field_tag :scenario_ids,
                     '',
                     placeholder: 'e.g. 123,456,789',
                     class: 'form-control w-auto d-inline-block',
                     id: 'scenario_ids_input'
    = link_to 'Download Dump',
              '#',
              class: 'btn btn-primary ms-2 disabled',
              id: 'download_link',
              download: ''

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('scenario_ids_input');
    var link  = document.getElementById('download_link');
    var baseUrl = "#{download_dump_inspect_scenarios_path}";

    input.addEventListener('input', function() {
      var ids = input.value.replace(/[^\d,]/g, '').trim();

      if (!ids) {
        link.classList.add('disabled');
        link.removeAttribute('href');
        link.removeAttribute('download');
        return;
      }

      link.href = baseUrl + '?type=user_input&scenario_ids=' + encodeURIComponent(ids);
      link.download = 'scenarios-' + ids.split(',').join('-') + '-dump.json';
      link.classList.remove('disabled');
    });
  });

.row
  .span12
    Import a dump
    = form_with url: load_dump_inspect_scenarios_path do |f_load|
      = f_load.file_field 'dump', accept: 'application/json'
      = f_load.submit 'Create scenarios', class: 'btn btn-primary'

%table.table.table-condensed.scenario-list
  %thead
    %tr
      %th{:colspan => 8} Scenario count: #{Scenario.count}
    %tr
      %th.narrow.text-center Visibility
      %th ID
      %th Owners
      %th End Year
      %th Area
      %th.narrow Compatibility
      %th
  %tfoot
    %tr
      %td{:colspan => 8}= paginate @scenarios
  %tbody
    - @scenarios.each do |s|
      %tr{ class: s.id.to_s == params[:api_scenario_id] ? 'active' : '' }
        %td.text-center
          - if s.private?
            %span.tag.private
              = inline_svg_tag 'font-awesome/16/lock.svg'
              Private
          - else
            %span.tag.gray Public
        %td
          = link_to s.id, inspect_scenario_path(:id => s.id)
          - if s.title
            %span{ style: 'margin: 0 0.25rem 0 0.5rem; font-weight: normal' }= s.title
          - if s.id.to_s == params[:api_scenario_id]
            %span.tag.green &#9733; Current Scenario
        %td
          - if s.scenario_users.present?
            - s.scenario_users.each do |scenario_user|
              - if scenario_user.user
                = link_to("#{scenario_user.user.name} (#{User::ROLES[scenario_user.role_id].to_s.humanize})", user_path(scenario_user.user))
              - else
                %span.muted= "#{scenario_user.email} (#{User::ROLES[scenario_user.role_id].to_s.humanize})"
          - else
            %span.muted No owner
        %td= s.end_year
        %td= s.area_code
        %td.narrow
          = formatted_scenario_compatibility(s)
        %td.actions
          - if params[:api_scenario_id] == s.id.to_s
            %span.muted Make active
          - else
            = link_to 'Make active', inspect_scenarios_path(@list_params.to_h.symbolize_keys.merge(api_scenario_id: s.id))
          = link_to 'Edit', edit_inspect_scenario_path(:id => s.id)
