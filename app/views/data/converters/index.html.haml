= render "list"

.header
  Converters for:
  = params[:blueprint_id]
  = params[:region_code]

- fields = (params[:fields] ||= 'demand').split(',').map(&:strip)
%table
  %thead
    %tr
      %th{:colspan => 3}
        = form_tag( {}, {:method => 'get'}) do
          Attributes:
          = text_field_tag :fields, (params[:fields])
          = submit_tag 'show'
      - fields.each do |field|
        %th{:colspan => 2}= field
    %tr
      %th id
      %th Key
      %th Graph
      - fields.each do |field|
        %th Present
        %th Future
  - @blueprint.converter_records.each do |converter|
    %tr
      %td== ##{converter.id}
      %td
        = link_to converter.full_key, data_converter_path(:id => converter)
      %td
        %small
          = link_to 'pres', data_converter_path(:id => converter, :format => 'svg'), :target => :blank
          |
          = link_to 'fut', data_converter_path(:id => converter, :format => 'svg', :graph => 'future'), :target => :blank

      - fields.each do |field|
        - if converter.full_key.present? and query = "V(#{converter.full_key};#{field})"
          - p, f = Current.gql.query(query).results
          %td.tar{:title => title_tag_number(p)}=auto_number(p)
          %td.tar{:title => title_tag_number(f)}= auto_number(f)
