// GRAPH is uppercase to make it obvious that it is in global namespace!
var GRAPH = new Graph();

<%
  @bp = @blueprint
  converters = @gql.present_graph.converters
  converter_ids = converters.map(&:id)

  converters.each do |converter|
    position = @converter_positions[converter.full_key]
    position ||= ConverterPosition.new(:converter_key => converter.full_key)
    if converter
      params = [converter.full_key, 
                converter.key,
                position.x || 100,
                position.y || 100,
                converter.sector_key.to_s,
                converter.use_key.to_s,
                converter.key]
      params << (position.hidden == true)
      params << position.fill_color
      params << position.stroke_color
    end
  -%>
<%= "new Converter(#{js_params(params)});".html_safe %>
<% end %>      

<% @bp.links.includes(:carrier).each do |bl| 
  if converter_ids.include?(bl.parent_id) and converter_ids.include?(bl.child_id)
    params = [bl.child_id, bl.parent_id, "#{bl.carrier.carrier_color || '#999'}", "1|#{bl.link_style}"]
    -%>
<%= "new Link(#{js_params(params)});".html_safe %>
  <% end %>
<% end %>

GRAPH.draw();