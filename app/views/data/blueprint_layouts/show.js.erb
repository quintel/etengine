// GRAPH is uppercase to make it obvious that it is in global namespace!
var GRAPH = new Graph();

<%
  @bp = @graph.blueprint
  blueprint_converters = @bp.converter_records.includes(:groups, :energy_balance_group).all
  blueprint_converter_ids = blueprint_converters.map(&:id)

  blueprint_converters.each do |bc|
    position = @converter_positions[bc.id]
    position ||= ConverterPosition.new(bc)

    params = [bc.id, bc.key, position.x_or_default, position.y_or_default, bc.sector_key.to_s, bc.use_key.to_s, bc.key]
    params << (position.hidden == true)
    params << position.fill_color
    params << position.stroke_color
  -%>
<%= "new Converter(#{js_params(params)});".html_safe %>
<% end %>      

<% @bp.links.includes(:carrier).each do |bl| 
  if blueprint_converter_ids.include?(bl.parent_id) and blueprint_converter_ids.include?(bl.child_id)
    params = [bl.child_id, bl.parent_id, "#{bl.carrier.carrier_color || '#999'}", "1|#{bl.link_style}"]
    -%>
<%= "new Link(#{js_params(params)});".html_safe %>
  <% end %>
<% end %>

GRAPH.draw();